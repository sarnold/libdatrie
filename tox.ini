[tox]
envlist = py3{6,7,8,9}-tests
skip_missing_interpreters = true
skipsdist = true

[testenv]
envdir = {toxinidir}/.env
skip_install = true

passenv =
    CI GITHUB*
    CC
    CXX
    CMAKE_BUILD_TYPE
    CMAKE_TOOLCHAIN_FILE
    CMAKE_GENERATOR
    PYTHONIOENCODING
    PIP_DOWNLOAD_CACHE

whitelist_externals =
    {tests,clang,ctest,clean,dist,auto,autoclean,win32}: bash
    {tests,clang}: mkdir

changedir =
    {tests,clang}: build

deps =
    {tests,clang,ctest,cover,win32}: pip>=19.0.1
    {tests,clang,ctest,win32}: cmake
    {tests,clang,ctest,win32}: ninja
    {tests,ctest,cover}: gcovr

commands_pre =
    {tests,clang}: mkdir -p {toxinidir}/build

commands =
    {auto,dist}: bash -c 'autoreconf -fi'
    {auto,dist}: bash -c './configure {posargs:"--disable-doxygen-doc"}'
    auto: bash -c 'make check'
    dist: bash -c 'make dist'
    clang: bash -c 'cmake -DCMAKE_TOOLCHAIN_FILE=../cmake/clang_toolchain.cmake ..'
    tests: bash -c 'cmake -DCMAKE_BUILD_TYPE=Debug -DWITH_COVERAGE=1 ..'
    {tests,clang}: bash -c 'cmake --build . -j $(nproc)'
    win32: bash -c 'ctest --build-generator {posargs:"MSYS Makefiles"} --build-and-test . build --build-options -DBUILD_STATIC_LIBS=ON -DCMAKE_BUILD_TYPE=Debug --test-command trietool.exe -V'
    {tests,clang}: bash -c 'ctest -V'
    ctest: bash -c 'ctest --build-generator {posargs:"Unix Makefiles"} --build-and-test . build --build-options -DWITH_COVERAGE=ON -DCMAKE_BUILD_TYPE=Debug --test-command ctest -V'
    {ctest,tests}: gcovr -s -b -r {toxinidir}/datrie/ build/
    cover: gcovr -r {toxinidir}/datrie/ --xml-pretty -o coverage.xml build/
    clean: bash -c 'rm -rf config.h build/ coverage.xml doc/html/'
    autoclean: bash -c 'make distclean-recursive'
    autoclean: bash -c 'rm -rf VERSION m4/ config.h config.h.in config.status config.log build-aux/compile build-aux/test-driver config.h.in~ autom4te.cache aclocal.m4 configure Makefile.in Makefile configure~'
